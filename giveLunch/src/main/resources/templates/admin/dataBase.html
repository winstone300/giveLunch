<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">
    <title>GiveLunch ê´€ë¦¬ì - ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬</title>
    <style>
        :root {
            font-family: "Pretendard", "Noto Sans KR", sans-serif;
            color: #1f2937;
            background-color: #f8fafc;
        }
        body {
            margin: 0;
            padding: 32px 24px 48px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }
        .logout-btn {
            background: #e2e8f0;
            color: #1f2937;
            font-weight: 600;
        }
        h1 {
            font-size: 26px;
            margin-bottom: 12px;
        }
        .subtitle {
            color: #64748b;
            margin-bottom: 28px;
        }
        .layout {
            display: grid;
            grid-template-columns: minmax(280px, 360px) 1fr;
            gap: 28px;
        }
        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }
        .search-group {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }
        .search-group input {
            flex: 1;
        }
        label {
            font-size: 13px;
            color: #475569;
        }
        input {
            border: 1px solid #cbd5f5;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
        }
        .actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        button {
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 14px;
            cursor: pointer;
        }
        .primary {
            background: #2563eb;
            color: #ffffff;
        }
        .secondary {
            background: #e2e8f0;
            color: #1f2937;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
        }
        th {
            background-color: #f1f5f9;
            color: #475569;
        }
        .table-actions {
            display: flex;
            gap: 6px;
        }
        .danger {
            background: #ef4444;
            color: #fff;
        }
        .notice {
            margin-top: 12px;
            color: #64748b;
            font-size: 13px;
        }.modal-overlay {
             position: fixed;
             inset: 0;
             background: rgba(15, 23, 42, 0.35);
             display: flex;
             align-items: center;
             justify-content: center;
             z-index: 1000;
             padding: 24px;
         }
        .modal-overlay.hidden {
            display: none;
        }
        .modal {
            width: min(560px, 100%);
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }
        .modal-close {
            background: transparent;
            font-size: 20px;
            line-height: 1;
            padding: 4px 8px;
        }
        .modal-results {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 60vh;
            overflow: auto;
        }
        .result-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            background: #f8fafc;
        }
        .result-image {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid #e2e8f0;
            background: #fff;
        }
        .result-info {
            flex: 1;
        }
        .result-title {
            font-weight: 600;
        }
        .result-meta {
            color: #64748b;
            font-size: 12px;
            margin-top: 4px;
        }
        .result-meta a {
            color: #2563eb;
            text-decoration: none;
        }
        .result-meta a:hover {
            text-decoration: underline;
        }
        .result-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        @media (max-width: 960px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>ğŸ± foods / nutritions ê´€ë¦¬</h1>
    <form th:action="@{/logout}" method="post">
        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
        <button type="submit" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </form>
</div>
<div class="subtitle">ìŒì‹ ì •ë³´ì™€ ì˜ì–‘ ì •ë³´ë¥¼ ë“±ë¡, ìˆ˜ì •, ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

<div class="layout">
    <section class="card">
        <h2>ìŒì‹ ë“±ë¡/ìˆ˜ì •</h2>
        <div class="form-group">
            <label for="food-search">ì™¸ë¶€ ë°ì´í„° ê²€ìƒ‰</label>
            <div class="search-group">
                <input id="food-search" type="text" placeholder="ì˜ˆ: ê¹€ì¹˜ì°Œê°œ">
                <button class="secondary" type="button" id="search-btn">ê²€ìƒ‰</button>
            </div>
            <div class="notice" id="search-status"></div>
        </div>
        <form id="food-form">
            <input type="hidden" id="food-id">
            <div class="form-group">
                <label for="food-name">ì´ë¦„ (í•„ìˆ˜)</label>
                <input id="food-name" type="text" required placeholder="ì˜ˆ: ê¹€ì¹˜ì°Œê°œ">
            </div>
            <div class="form-group">
                <label for="food-category">ì¹´í…Œê³ ë¦¬</label>
                <input id="food-category" type="text" placeholder="ì˜ˆ: í•œì‹">
            </div>
            <div class="form-group">
                <label for="food-img">ì´ë¯¸ì§€ URL</label>
                <input id="food-img" type="url" placeholder="https://...">
            </div>
            <div class="form-group">
                <label for="food-serving">1íšŒ ì œê³µëŸ‰ (g)</label>
                <input id="food-serving" type="number" min="0" step="1" placeholder="ì˜ˆ: 300">
            </div>
            <div class="form-group">
                <label for="food-calories">ì¹¼ë¡œë¦¬ (kcal)</label>
                <input id="food-calories" type="number" min="0" step="0.01" placeholder="ì˜ˆ: 550">
            </div>
            <div class="form-group">
                <label for="food-carb">íƒ„ìˆ˜í™”ë¬¼ (g)</label>
                <input id="food-carb" type="number" min="0" step="0.01" placeholder="ì˜ˆ: 60">
            </div>
            <div class="form-group">
                <label for="food-protein">ë‹¨ë°±ì§ˆ (g)</label>
                <input id="food-protein" type="number" min="0" step="0.01" placeholder="ì˜ˆ: 25">
            </div>
            <div class="form-group">
                <label for="food-fat">ì§€ë°© (g)</label>
                <input id="food-fat" type="number" min="0" step="0.01" placeholder="ì˜ˆ: 18">
            </div>
            <div class="actions">
                <button class="primary" type="submit">ì €ì¥</button>
                <button class="secondary" type="button" id="reset-btn">ì´ˆê¸°í™”</button>
            </div>
        </form>
        <div class="notice" id="form-status"></div>
    </section>

    <section class="card">
        <h2>ë“±ë¡ëœ ìŒì‹ ëª©ë¡</h2>
        <table>
            <thead>
            <tr>
                <th>ì´ë¦„</th>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>ì•¡ì…˜</th>
            </tr>
            </thead>
            <tbody id="food-table-body"></tbody>
        </table>
        <div class="notice">í‘œì‹œë˜ëŠ” ì¹¼ë¡œë¦¬ëŠ” 1íšŒ ì œê³µëŸ‰ ê¸°ì¤€ì…ë‹ˆë‹¤.</div>
    </section>
</div>

<div class="modal-overlay hidden" id="search-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="search-modal-title">
        <div class="modal-header">
            <div class="modal-title" id="search-modal-title">ì™¸ë¶€ ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼</div>
            <button class="modal-close" type="button" id="search-modal-close" aria-label="ë‹«ê¸°">âœ•</button>
        </div>
        <div class="modal-results" id="search-results"></div>
    </div>
</div>

<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    const form = document.getElementById('food-form');
    const formStatus = document.getElementById('form-status');
    const tableBody = document.getElementById('food-table-body');
    const searchInput = document.getElementById('food-search');
    const searchButton = document.getElementById('search-btn');
    const searchStatus = document.getElementById('search-status');
    const searchResults = document.getElementById('search-results');
    const searchModal = document.getElementById('search-modal');
    const searchModalClose = document.getElementById('search-modal-close');

    const fields = {
        id: document.getElementById('food-id'),
        name: document.getElementById('food-name'),
        category: document.getElementById('food-category'),
        imgUrl: document.getElementById('food-img'),
        servingSizeG: document.getElementById('food-serving'),
        calories: document.getElementById('food-calories'),
        carbohydrate: document.getElementById('food-carb'),
        protein: document.getElementById('food-protein'),
        fat: document.getElementById('food-fat')
    };

    const request = (url, options = {}) => {
        const headers = options.headers ? {...options.headers} : {};
        if (csrfToken && csrfHeader && options.method && options.method !== 'GET') {
            headers[csrfHeader] = csrfToken;
        }
        return fetch(url, {...options, headers});
    };

    const getPayload = () => ({
        name: fields.name.value.trim(),
        category: fields.category.value.trim() || null,
        imgUrl: fields.imgUrl.value.trim() || null,
        servingSizeG: fields.servingSizeG.value ? Number(fields.servingSizeG.value) : null,
        nutrition: {
            calories: fields.calories.value ? Number(fields.calories.value) : null,
            carbohydrate: fields.carbohydrate.value ? Number(fields.carbohydrate.value) : null,
            protein: fields.protein.value ? Number(fields.protein.value) : null,
            fat: fields.fat.value ? Number(fields.fat.value) : null
        }
    });

    const resetForm = () => {
        form.reset();
        fields.id.value = '';
        formStatus.textContent = '';
    };

    const openSearchModal = () => {
        searchModal.classList.remove('hidden');
        searchModal.setAttribute('aria-hidden', 'false');
    };

    const closeSearchModal = () => {
        searchModal.classList.add('hidden');
        searchModal.setAttribute('aria-hidden', 'true');
    };

    const applyExternalFood = (dto) => {
        fields.id.value = '';
        fields.name.value = dto.name ?? '';
        fields.category.value = dto.category ?? '';
        fields.imgUrl.value = dto.imgUrl ?? '';
        fields.servingSizeG.value = dto.servingSizeG ?? '';
        fields.calories.value = dto.nutrition?.calories ?? '';
        fields.carbohydrate.value = dto.nutrition?.carbohydrate ?? '';
        fields.protein.value = dto.nutrition?.protein ?? '';
        fields.fat.value = dto.nutrition?.fat ?? '';
    };

    const renderSearchResults = (results) => {
        searchResults.innerHTML = '';
        if (!results.length) {
            searchResults.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
            openSearchModal();
            return;
        }

        results.forEach((item) => {
            const card = document.createElement('div');
            card.className = 'result-card';

            if (item.imgUrl) {
                const image = document.createElement('img');
                image.className = 'result-image';
                image.src = item.imgUrl;
                image.alt = `${item.name ?? 'ìŒì‹'} ì´ë¯¸ì§€`;
                card.appendChild(image);
            }

            const info = document.createElement('div');
            info.className = 'result-info';
            const title = document.createElement('div');
            title.className = 'result-title';
            title.textContent = item.name ?? 'ì´ë¦„ ì—†ìŒ';

            const meta = document.createElement('div');
            meta.className = 'result-meta';
            const details = [
                item.category ? `ì¹´í…Œê³ ë¦¬: ${item.category}` : null,
                item.servingSizeG ? `1íšŒ ì œê³µëŸ‰: ${item.servingSizeG}g` : null,
                item.nutrition?.calories ? `ì¹¼ë¡œë¦¬: ${item.nutrition.calories}kcal` : null
            ].filter(Boolean);
            meta.textContent = details.join(' Â· ') || 'ì„¸ë¶€ ì •ë³´ ì—†ìŒ';

            if (item.imgUrl) {
                const link = document.createElement('a');
                link.href = item.imgUrl;
                link.target = '_blank';
                link.rel = 'noopener';
                link.textContent = 'ì´ë¯¸ì§€ URL';
                meta.appendChild(document.createTextNode(details.length ? ' Â· ' : ''));
                meta.appendChild(link);
            }


            info.appendChild(title);
            info.appendChild(meta);

            const actions = document.createElement('div');
            actions.className = 'result-actions';
            const selectButton = document.createElement('button');
            selectButton.type = 'button';
            selectButton.className = 'secondary';
            selectButton.textContent = 'ì„ íƒ';
            selectButton.addEventListener('click', () => {
                applyExternalFood(item);
                formStatus.textContent = 'ì™¸ë¶€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ';
                closeSearchModal();
            });

            actions.appendChild(selectButton);
            card.appendChild(info);
            card.appendChild(actions);

            searchResults.appendChild(card);
        });
        openSearchModal();
    };


    const searchExternalFood = async () => {
        const name = searchInput.value.trim();
        if (!name) {
            searchStatus.textContent = 'ê²€ìƒ‰í•  ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            searchResults.innerHTML = '';
            return;
        }
        searchStatus.textContent = 'ì™¸ë¶€ ë°ì´í„° ì¡°íšŒ ì¤‘...';
        searchResults.innerHTML = '';
        const resp = await fetch(`/api/foods/search/external?name=${encodeURIComponent(name)}`);
        if (!resp.ok) {
            searchStatus.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
            renderSearchResults([]);
            return;
        }
        const data = await resp.json();
        const results = Array.isArray(data) ? data : [data];
        searchStatus.textContent = `${results.length}ê±´ ê²€ìƒ‰ ì™„ë£Œ`;
        renderSearchResults(results);
    };


    const renderRows = (foods) => {
        tableBody.innerHTML = '';
        foods.forEach((food) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${food.name}</td>
                <td>${food.category ?? '-'}</td>
                <td class="table-actions">
                    <button class="secondary" data-action="edit">ìˆ˜ì •</button>
                    <button class="danger" data-action="delete">ì‚­ì œ</button>
                </td>
            `;

            row.querySelector('[data-action="edit"]').addEventListener('click', async () => {
                fields.id.value = food.id;
                fields.name.value = food.name ?? '';
                fields.category.value = food.category ?? '';
                fields.imgUrl.value = food.imgUrl ?? '';
                fields.servingSizeG.value = food.servingSizeG ?? '';
                fields.calories.value = '';
                fields.carbohydrate.value = '';
                fields.protein.value = '';
                fields.fat.value = '';
                formStatus.textContent = `ID ${food.id} ì˜ì–‘ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`;

                const nutrition = await loadNutrition(food.id);
                if (nutrition) {
                    fields.calories.value = nutrition.calories ?? '';
                    fields.carbohydrate.value = nutrition.carbohydrate ?? '';
                    fields.protein.value = nutrition.protein ?? '';
                    fields.fat.value = nutrition.fat ?? '';
                    formStatus.textContent = `ID ${food.id} ìˆ˜ì • ì¤‘`;
                } else {
                    formStatus.textContent = `ID ${food.id} ìˆ˜ì • ì¤‘ (ì˜ì–‘ ì •ë³´ ì—†ìŒ)`;
                }
            });

            row.querySelector('[data-action="delete"]').addEventListener('click', async () => {
                if (!confirm(`${food.name} í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?`)) {
                    return;
                }
                const resp = await request(`/api/admin/foods/${food.id}`, {method: 'DELETE'});
                if (!resp.ok) {
                    formStatus.textContent = 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    return;
                }
                formStatus.textContent = 'ì‚­ì œ ì™„ë£Œ';
                await loadFoods();
                if (fields.id.value === String(food.id)) {
                    resetForm();
                }
            });

            tableBody.appendChild(row);
        });
    };

    const loadFoods = async () => {
        const resp = await fetch('/api/admin/foods');
        if (!resp.ok) {
            formStatus.textContent = 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            return;
        }
        const data = await resp.json();
        renderRows(data);
    };

    const loadNutrition = async (foodId) => {
        const resp = await fetch(`/api/foods/${foodId}/nutrition`);
        if (!resp.ok) {
            return null;
        }
        const data = await resp.json();
        return data.nutrition ?? null;
    };

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = getPayload();

        if (!payload.name) {
            formStatus.textContent = 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }

        const id = fields.id.value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/admin/foods/${id}` : '/api/admin/foods';
        const resp = await request(url, {
            method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!resp.ok) {
            const message = await resp.text();
            formStatus.textContent = message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            return;
        }
        formStatus.textContent = id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡ ì™„ë£Œ';
        resetForm();
        await loadFoods();
    });

    document.getElementById('reset-btn').addEventListener('click', resetForm);
    searchButton.addEventListener('click', searchExternalFood);
    searchModalClose.addEventListener('click', closeSearchModal);
    searchModal.addEventListener('click', (event) => {
        if (event.target === searchModal) {
            closeSearchModal();
        }
    });
    searchInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            searchExternalFood();
        }
    });
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !searchModal.classList.contains('hidden')) {
            closeSearchModal();
        }
    });

    loadFoods();
</script>
</body>
</html>