<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">
    <title>GiveLunch ê´€ë¦¬ì - ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬</title>
    <style>
        :root {
            font-family: "Pretendard", "Noto Sans KR", sans-serif;
            color: #1f2937;
            background-color: #f8fafc;
        }
        body {
            margin: 0;
            padding: 32px 24px 48px;
        }
        h1 {
            font-size: 26px;
            margin-bottom: 12px;
        }
        .subtitle {
            color: #64748b;
            margin-bottom: 28px;
        }
        .layout {
            display: grid;
            grid-template-columns: minmax(280px, 360px) 1fr;
            gap: 28px;
        }
        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }
        label {
            font-size: 13px;
            color: #475569;
        }
        input {
            border: 1px solid #cbd5f5;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
        }
        .actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        button {
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 14px;
            cursor: pointer;
        }
        .primary {
            background: #2563eb;
            color: #ffffff;
        }
        .secondary {
            background: #e2e8f0;
            color: #1f2937;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
        }
        th {
            background-color: #f1f5f9;
            color: #475569;
        }
        .table-actions {
            display: flex;
            gap: 6px;
        }
        .danger {
            background: #ef4444;
            color: #fff;
        }
        .notice {
            margin-top: 12px;
            color: #64748b;
            font-size: 13px;
        }
        @media (max-width: 960px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<h1>ğŸ± foods / nutritions ê´€ë¦¬</h1>
<div class="subtitle">ìŒì‹ ì •ë³´ì™€ ì˜ì–‘ ì •ë³´ë¥¼ ë“±ë¡, ìˆ˜ì •, ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

<div class="layout">
    <section class="card">
        <h2>ìŒì‹ ë“±ë¡/ìˆ˜ì •</h2>
        <form id="food-form">
            <input type="hidden" id="food-id">
            <div class="form-group">
                <label for="food-name">ì´ë¦„ (í•„ìˆ˜)</label>
                <input id="food-name" type="text" required placeholder="ì˜ˆ: ê¹€ì¹˜ì°Œê°œ">
            </div>
            <div class="form-group">
                <label for="food-category">ì¹´í…Œê³ ë¦¬</label>
                <input id="food-category" type="text" placeholder="ì˜ˆ: í•œì‹">
            </div>
            <div class="form-group">
                <label for="food-img">ì´ë¯¸ì§€ URL</label>
                <input id="food-img" type="url" placeholder="https://...">
            </div>
            <div class="form-group">
                <label for="food-serving">1íšŒ ì œê³µëŸ‰ (g)</label>
                <input id="food-serving" type="number" min="0" step="1" placeholder="ì˜ˆ: 300">
            </div>
            <div class="form-group">
                <label for="food-calories">ì¹¼ë¡œë¦¬ (kcal)</label>
                <input id="food-calories" type="number" min="0" step="0.01" placeholder="ì˜ˆ: 550">
            </div>
            <div class="form-group">
                <label for="food-carb">íƒ„ìˆ˜í™”ë¬¼ (g)</label>
                <input id="food-carb" type="number" min="0" step="0.01" placeholder="ì˜ˆ: 60">
            </div>
            <div class="form-group">
                <label for="food-protein">ë‹¨ë°±ì§ˆ (g)</label>
                <input id="food-protein" type="number" min="0" step="0.01" placeholder="ì˜ˆ: 25">
            </div>
            <div class="form-group">
                <label for="food-fat">ì§€ë°© (g)</label>
                <input id="food-fat" type="number" min="0" step="0.01" placeholder="ì˜ˆ: 18">
            </div>
            <div class="actions">
                <button class="primary" type="submit">ì €ì¥</button>
                <button class="secondary" type="button" id="reset-btn">ì´ˆê¸°í™”</button>
            </div>
        </form>
        <div class="notice" id="form-status"></div>
    </section>

    <section class="card">
        <h2>ë“±ë¡ëœ ìŒì‹ ëª©ë¡</h2>
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>ì´ë¦„</th>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>ì¹¼ë¡œë¦¬</th>
                <th>ì•¡ì…˜</th>
            </tr>
            </thead>
            <tbody id="food-table-body"></tbody>
        </table>
        <div class="notice">í‘œì‹œë˜ëŠ” ì¹¼ë¡œë¦¬ëŠ” 1íšŒ ì œê³µëŸ‰ ê¸°ì¤€ì…ë‹ˆë‹¤.</div>
    </section>
</div>

<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    const form = document.getElementById('food-form');
    const formStatus = document.getElementById('form-status');
    const tableBody = document.getElementById('food-table-body');

    const fields = {
        id: document.getElementById('food-id'),
        name: document.getElementById('food-name'),
        category: document.getElementById('food-category'),
        imgUrl: document.getElementById('food-img'),
        servingSizeG: document.getElementById('food-serving'),
        calories: document.getElementById('food-calories'),
        carbohydrate: document.getElementById('food-carb'),
        protein: document.getElementById('food-protein'),
        fat: document.getElementById('food-fat')
    };

    const request = (url, options = {}) => {
        const headers = options.headers ? {...options.headers} : {};
        if (csrfToken && csrfHeader && options.method && options.method !== 'GET') {
            headers[csrfHeader] = csrfToken;
        }
        return fetch(url, {...options, headers});
    };

    const getPayload = () => ({
        name: fields.name.value.trim(),
        category: fields.category.value.trim() || null,
        imgUrl: fields.imgUrl.value.trim() || null,
        servingSizeG: fields.servingSizeG.value ? Number(fields.servingSizeG.value) : null,
        nutrition: {
            calories: fields.calories.value ? Number(fields.calories.value) : null,
            carbohydrate: fields.carbohydrate.value ? Number(fields.carbohydrate.value) : null,
            protein: fields.protein.value ? Number(fields.protein.value) : null,
            fat: fields.fat.value ? Number(fields.fat.value) : null
        }
    });

    const resetForm = () => {
        form.reset();
        fields.id.value = '';
        formStatus.textContent = '';
    };

    const renderRows = (foods) => {
        tableBody.innerHTML = '';
        foods.forEach((food) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${food.id}</td>
                <td>${food.name}</td>
                <td>${food.category ?? '-'}</td>
                <td>${food.nutrition?.calories ?? '-'}</td>
                <td class="table-actions">
                    <button class="secondary" data-action="edit">ìˆ˜ì •</button>
                    <button class="danger" data-action="delete">ì‚­ì œ</button>
                </td>
            `;

            row.querySelector('[data-action="edit"]').addEventListener('click', async () => {
                fields.id.value = food.id;
                fields.name.value = food.name ?? '';
                fields.category.value = food.category ?? '';
                fields.imgUrl.value = food.imgUrl ?? '';
                fields.servingSizeG.value = food.servingSizeG ?? '';
                fields.calories.value = '';
                fields.carbohydrate.value = '';
                fields.protein.value = '';
                fields.fat.value = '';
                formStatus.textContent = `ID ${food.id} ì˜ì–‘ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`;

                const nutrition = await loadNutrition(food.id);
                if (nutrition) {
                    fields.calories.value = nutrition.calories ?? '';
                    fields.carbohydrate.value = nutrition.carbohydrate ?? '';
                    fields.protein.value = nutrition.protein ?? '';
                    fields.fat.value = nutrition.fat ?? '';
                    formStatus.textContent = `ID ${food.id} ìˆ˜ì • ì¤‘`;
                } else {
                    formStatus.textContent = `ID ${food.id} ìˆ˜ì • ì¤‘ (ì˜ì–‘ ì •ë³´ ì—†ìŒ)`;
                }
            });

            row.querySelector('[data-action="delete"]').addEventListener('click', async () => {
                if (!confirm(`${food.name} í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?`)) {
                    return;
                }
                const resp = await request(`/api/admin/foods/${food.id}`, {method: 'DELETE'});
                if (!resp.ok) {
                    formStatus.textContent = 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    return;
                }
                formStatus.textContent = 'ì‚­ì œ ì™„ë£Œ';
                await loadFoods();
                if (fields.id.value === String(food.id)) {
                    resetForm();
                }
            });

            tableBody.appendChild(row);
        });
    };

    const loadFoods = async () => {
        const resp = await fetch('/api/admin/foods');
        if (!resp.ok) {
            formStatus.textContent = 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            return;
        }
        const data = await resp.json();
        renderRows(data);
    };

    const loadNutrition = async (foodId) => {
        const resp = await fetch(`/api/foods/${foodId}/nutrition`);
        if (!resp.ok) {
            return null;
        }
        const data = await resp.json();
        return data.nutrition ?? null;
    };

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = getPayload();

        if (!payload.name) {
            formStatus.textContent = 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            return;
        }

        const id = fields.id.value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/admin/foods/${id}` : '/api/admin/foods';
        const resp = await request(url, {
            method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!resp.ok) {
            const message = await resp.text();
            formStatus.textContent = message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            return;
        }
        formStatus.textContent = id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡ ì™„ë£Œ';
        resetForm();
        await loadFoods();
    });

    document.getElementById('reset-btn').addEventListener('click', resetForm);

    loadFoods();
</script>
</body>
</html>