<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">
    <title>ì˜¤ëŠ˜ ë­ ë¨¹ì§€? - GiveLunch</title>

    <style>
        :root { --primary: #6c5ce7; --secondary: #a29bfe; --accent: #ff7675; --bg: #f0f3f7; }
        body { font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; background-color: var(--bg); margin: 0; padding: 20px; }

        .header { width: 100%; max-width: 820px; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: white; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .auth-btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; text-decoration: none; font-size: 14px; }
        .login-btn { background: var(--primary); color: white; }
        .logout-btn { background: #dfe6e9; color: #636e72; }

        .menu-card { width: 100%; max-width: 820px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .menu-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: block; }
        #menu-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .menu-item { background: #f1f2f6; padding: 6px 12px; border-radius: 20px; font-size: 14px; display: flex; align-items: center; gap: 6px; }
        .del-btn { color: var(--accent); cursor: pointer; font-weight: bold; }
        .input-group { display: flex; gap: 8px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        input:focus { border-color: var(--primary); }
        .add-btn { background: #55efc4; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .main-grid {
            width: 100%;
            max-width: 820px;
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 18px;
            align-items: start;
        }

        .roulette-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .roulette-container { position: relative; width: 350px; height: 350px; margin: 20px 0; }
        #canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 4s cubic-bezier(0.1, 0, 0, 1); }
        .arrow { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--accent); z-index: 10; }

        .spin-btn { padding: 16px 60px; font-size: 18px; font-weight: bold; color: white; background: var(--primary); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 6px 20px rgba(108, 92, 231, 0.3); }
        #result { margin-top: 25px; font-size: 24px; font-weight: 800; color: #2d3436; min-height: 1.5em; text-align: center;}

        .nutrition-card {
            width: 320px;
            background: white;
            padding: 18px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: sticky;
            top: 20px;
            justify-self: end;
        }
        .nutrition-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
        .nutrition-title { font-weight: 800; font-size: 16px; margin-bottom: 10px; }
        .nutrition-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f2f6; font-size: 14px; }
        .nutrition-row:last-child { border-bottom: none; }
        .nutrition-image { width: 72px; height: 72px; border-radius: 10px; object-fit: cover; flex-shrink: 0; }
        .nutrition-image.is-hidden { display: none; }
        .muted { color: #636e72; font-size: 13px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #f1f2f6; font-size: 12px; font-weight: 700; margin-top: 8px; }
        .err { color: #d63031; font-size: 13px; margin-top: 8px; white-space: pre-line; }

        @media (max-width: 860px) {
            .header, .menu-card, .main-grid { max-width: 450px; }
            .main-grid { grid-template-columns: 1fr; }
            .nutrition-card { width: 100%; position: static; }
        }
    </style>
</head>

<body>

<div class="header">
    <div id="status-text"
         th:text="${isLoggedIn} ? 'ğŸ‘¤ íšŒì› ëª¨ë“œ (' + ${userName} + 'ë‹˜)' : 'ğŸ‘‹ ë°˜ê°‘ìŠµë‹ˆë‹¤! (GUEST)'">ìƒíƒœ</div>
    <a th:if="${!isLoggedIn}" th:href="@{/login}" class="auth-btn login-btn">ë¡œê·¸ì¸</a>
    <form th:if="${isLoggedIn}" th:action="@{/logout}" method="post">
        <button type="submit" class="auth-btn logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </form>
</div>

<div class="menu-card">
    <span class="menu-title" th:text="${isLoggedIn} ? 'ğŸ“‚ ë‚˜ì˜ ì»¤ìŠ¤í…€ ë©”ë‰´' : 'ğŸ“‚ ê²ŒìŠ¤íŠ¸ ë¡œì»¬ ë©”ë‰´'">ë©”ë‰´ ë¦¬ìŠ¤íŠ¸</span>
    <div id="menu-list"></div>

    <div class="input-group">
        <input type="text" id="menu-input" placeholder="ìƒˆ ë©”ë‰´ ì¶”ê°€" onkeypress="if(event.keyCode==13) addMenu()">
        <button class="add-btn" onclick="addMenu()">ì¶”ê°€</button>
    </div>
</div>

<div class="main-grid">
    <!-- ì™¼ìª½: ë£°ë › -->
    <div class="roulette-panel">
        <div class="roulette-container">
            <div class="arrow"></div>
            <canvas id="canvas" width="400" height="400"></canvas>
        </div>

        <button class="spin-btn" onclick="spinWheel()">ë£°ë › ëŒë¦¬ê¸°!</button>
        <div id="result"></div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì˜ì–‘ì •ë³´ -->
    <div class="nutrition-card">
        <div class="nutrition-header">
            <div class="nutrition-title">ğŸ½ ì˜ì–‘ ì •ë³´</div>
            <img id="nutrition-image" class="nutrition-image is-hidden" alt="ë©”ë‰´ ì´ë¯¸ì§€">
        </div>
        <div id="nutrition-content" class="muted">
            ë£°ë ›ì„ ëŒë ¤ì„œ ë©”ë‰´ë¥¼ ì„ íƒí•˜ë©´ ì˜ì–‘ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.
        </div>
    </div>
</div>

<script th:inline="javascript">
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');
    const nutritionContent = document.getElementById('nutrition-content');
    const nutritionImage = document.getElementById('nutrition-image');

    // 1. ì´ˆê¸° ë°ì´í„° ì„¤ì •
    const isLoggedIn = [[${isLoggedIn}]];
    let currentMenu = [[${menuList}]]; // ì„œë²„ê°€ ì¤€ ë°ì´í„° (ë¡œê·¸ì¸ ì‹œ DBê°’, ë¹„ë¡œê·¸ì¸ ì‹œ ê¸°ë³¸ê°’)
    let currentRotation = 0;

    // ê²ŒìŠ¤íŠ¸ë¼ë©´ LocalStorage í™•ì¸ í›„ ë®ì–´ì“°ê¸°
    if (!isLoggedIn) {
        const localData = localStorage.getItem('guestMenu');
        if (localData) currentMenu = JSON.parse(localData);
    }

    function renderMenuList() {
        const listDiv = document.getElementById('menu-list');
        listDiv.innerHTML = currentMenu.map((m, i) =>
            `<div class="menu-item">
          ${m} <span class="del-btn" onclick="deleteMenu('${m}', ${i})">Ã—</span>
       </div>`
        ).join('');
    }

    function buildCsrfHeaders() {
        const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const headerName = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
        return token && headerName ? { [headerName]: token } : {};
    }

    // 2. ë©”ë‰´ ì¶”ê°€ (ë¶„ê¸° ì²˜ë¦¬)
    async function addMenu() {
        const input = document.getElementById('menu-input');
        const menuName = input.value.trim();
        if (!menuName) return;

        if (isLoggedIn) {
            // íšŒì›: DBì— ì €ì¥
            try {
                const response = await fetch('/api/menus', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...buildCsrfHeaders() },
                    body: JSON.stringify({ menuName: menuName })
                });
                if (response.ok) currentMenu.push(menuName);
                else{ // ì‹¤íŒ¨ ì²˜ë¦¬(ë‚˜ì¤‘ì—)
                }
            } catch (e) { alert("ì„œë²„ ì €ì¥ ì‹¤íŒ¨!"); return; }
        } else {
            // ê²ŒìŠ¤íŠ¸: LocalStorageì— ì €ì¥
            currentMenu.push(menuName);
            localStorage.setItem('guestMenu', JSON.stringify(currentMenu));
        }

        input.value = "";
        updateGame();
    }

    // 3. ë©”ë‰´ ì‚­ì œ (ë¶„ê¸° ì²˜ë¦¬)
    async function deleteMenu(menuName, index) {
        if (currentMenu.length <= 2) return alert("ìµœì†Œ 2ê°œì˜ ë©”ë‰´ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

        if (isLoggedIn) {
            // íšŒì›: DBì—ì„œ ì‚­ì œ
            try {
                const response = await fetch('/api/menus/delete', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', ...buildCsrfHeaders() },
                    body: JSON.stringify({ menuName: menuName })
                });
                if (response.ok) currentMenu.splice(index, 1);
                else{ // ì‹¤íŒ¨ ì²˜ë¦¬
                }
            } catch (e) { alert("ì„œë²„ ì‚­ì œ ì‹¤íŒ¨!"); return; }
        } else {
            // ê²ŒìŠ¤íŠ¸: LocalStorageì—ì„œ ì‚­ì œ
            currentMenu.splice(index, 1);
            localStorage.setItem('guestMenu', JSON.stringify(currentMenu));
        }
        updateGame();
    }

    function updateGame() {
        renderMenuList();
        drawWheel();
    }

    // ë£°ë › ê·¸ë¦¬ê¸°
    const colors = ["#6c5ce7", "#74b9ff", "#a29bfe", "#81ecec", "#55efc4", "#fab1a0", "#ff7675", "#fd79a8"];
    function drawWheel() {
        const totalSlices = currentMenu.length;
        const arc = (Math.PI * 2) / totalSlices;

        ctx.clearRect(0, 0, 400, 400);
        for (let i = 0; i < totalSlices; i++) {
            const angle = i * arc;
            ctx.fillStyle = colors[i % colors.length];
            ctx.beginPath();
            ctx.moveTo(200, 200);
            ctx.arc(200, 200, 200, angle, angle + arc);
            ctx.fill();

            ctx.save();
            ctx.translate(200 + Math.cos(angle + arc / 2) * 140, 200 + Math.sin(angle + arc / 2) * 140);
            ctx.rotate(angle + arc / 2 + Math.PI / 2);
            ctx.fillStyle = "white";
            ctx.font = "bold 15px Arial";
            ctx.textAlign = "center";
            ctx.fillText(currentMenu[i], 0, 0);
            ctx.restore();
        }
    }

    // =========================
    // ì˜ì–‘ì •ë³´ ë Œë”ë§
    // =========================
    function renderNutritionLoading(menuName) {
        nutritionImage.classList.add('is-hidden');
        nutritionImage.removeAttribute('src');
        nutritionContent.innerHTML = `<div class="muted">"${menuName}" ì˜ì–‘ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;
    }

    function renderNutritionError(menuName, message) {
        nutritionImage.classList.add('is-hidden');
        nutritionImage.removeAttribute('src');
        nutritionContent.innerHTML = `
      <div><b>${menuName}</b></div>
      <div class="err">${message}</div>
    `;
    }

    function renderNutrition(data) {
        // { foodId, name, category, servingSizeG, nutrition:{calories,protein,fat,carbohydrate}, source }

        const n = data.nutrition ?? {};
        const serving = data.servingSizeG ? `${data.servingSizeG}g` : "-";
        const source = data.source ?? "UNKNOWN";
        const imgUrl = data.imgUrl ?? "";

        if (imgUrl) {
            nutritionImage.src = imgUrl;
            nutritionImage.classList.remove('is-hidden');
        } else {
            nutritionImage.classList.add('is-hidden');
            nutritionImage.removeAttribute('src');
        }

        // BigDecimalì´ JSONì—ì„œ ìˆ«ì/ë¬¸ìì—´ë¡œ ì˜¬ ìˆ˜ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ì¶œë ¥
        nutritionContent.innerHTML = `
      <div style="font-weight:800; font-size:15px;">${data.name ?? "-"}</div>
      <div class="muted">${data.category ?? ""}</div>

      <div class="nutrition-row"><span>ê¸°ì¤€</span><span>${serving}</span></div>
      <div class="nutrition-row"><span>ì¹¼ë¡œë¦¬</span><span>${n.calories ?? "-"} kcal</span></div>
      <div class="nutrition-row"><span>íƒ„ìˆ˜í™”ë¬¼</span><span>${n.carbohydrate ?? "-"} g</span></div>
      <div class="nutrition-row"><span>ë‹¨ë°±ì§ˆ</span><span>${n.protein ?? "-"} g</span></div>
      <div class="nutrition-row"><span>ì§€ë°©</span><span>${n.fat ?? "-"} g</span></div>

      <div class="badge">SOURCE: ${source}</div>
    `;
    }

    // /api/foods/{foodId}/nutrition í˜¸ì¶œ í›„ ì˜¤ë¥¸ìª½ ì¶œë ¥
    async function fetchAndRenderNutrition(menuName) {
        renderNutritionLoading(menuName);

        try {
            const url = `/api/foods/getId?name=${encodeURIComponent(menuName)}`;
            const idResp = await fetch(url);
            if (!idResp.ok) {
                const errorData = await idResp.json().catch(() => null);
                const msg = errorData ? errorData.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
                renderNutritionError(menuName, msg);
                return;
            }

            const idData = await idResp.text();
            const foodId = Number(idData);
            if (!foodId) {
                const externalResp = await fetch(`/api/foods/external?name=${encodeURIComponent(menuName)}`);
                if (!externalResp.ok) {
                    const errorData = await externalResp.json().catch(() => null);
                    const msg = errorData ? errorData.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
                    renderNutritionError(menuName, msg);
                    return;
                }

                const externalData = await externalResp.json();

                renderNutrition(externalData[0]);
                return;
            }
            const resp = await fetch(`/api/foods/${foodId}/nutrition`);
            if (!resp.ok) {
                const text = await resp.text().catch(() => "");
                renderNutritionError(menuName, `ì˜ì–‘ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (HTTP ${resp.status})\n${text}`);
                return;
            }

            const data = await resp.json();
            renderNutrition(data);
        } catch (e) {
            renderNutritionError(menuName, `ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n${e}`);
        }
    }

    // =========================
    // ë£°ë › ëŒë¦¬ê¸° -> ê²°ê³¼ -> ì˜ì–‘ì •ë³´ ì¡°íšŒ
    // =========================
    function spinWheel() {
        resultDiv.innerText = "ìš´ëª…ì˜ ë©”ë‰´ëŠ”?";
        const randomExtra = Math.floor(Math.random() * 360);
        currentRotation += (1800 + randomExtra);
        canvas.style.transform = `rotate(-${currentRotation}deg)`;

        setTimeout(() => {
            const sliceDegree = 360 / currentMenu.length;
            const winnerIndex = Math.floor(((currentRotation % 360 + 270) % 360) / sliceDegree);
            const winnerName = currentMenu[winnerIndex];

            resultDiv.innerText = `ì˜¤ëŠ˜ì˜ ë©”ë‰´: ${winnerName}!`;

            // âœ… ì—¬ê¸°ì„œ ì˜ì–‘ì •ë³´ API í˜¸ì¶œ
            fetchAndRenderNutrition(winnerName);
        }, 4000);
    }

    updateGame();
</script>

</body>
</html>
