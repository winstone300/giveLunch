<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ ë­ ë¨¹ì§€? - GiveLunch</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #ff7675;
            --bg: #f0f3f7;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
        }

        /* ìƒë‹¨ ìƒíƒœë°” */
        .header {
            width: 100%;
            max-width: 450px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .auth-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            text-decoration: none;
            font-size: 14px;
        }
        .login-btn { background: var(--primary); color: white; }
        .logout-btn { background: #dfe6e9; color: #636e72; }

        /* ë©”ë‰´ ê´€ë¦¬ ì„¹ì…˜ */
        .menu-card {
            width: 100%;
            max-width: 450px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .menu-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: block; }

        #menu-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .menu-item {
            background: #f1f2f6;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .del-btn { color: var(--accent); cursor: pointer; font-weight: bold; }

        .input-group { display: flex; gap: 8px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        input:focus { border-color: var(--primary); }
        .add-btn { background: #55efc4; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* ë£°ë › ë””ìì¸ */
        .roulette-container { position: relative; width: 350px; height: 350px; margin: 20px 0; }
        #canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 4s cubic-bezier(0.1, 0, 0, 1); }
        .arrow {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--accent);
            z-index: 10;
        }

        .spin-btn {
            padding: 16px 60px; font-size: 18px; font-weight: bold; color: white;
            background: var(--primary); border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.3);
        }

        #result { margin-top: 25px; font-size: 24px; font-weight: 800; color: #2d3436; min-height: 1.5em; }
    </style>
</head>
<body>

<div class="header">
    <div id="status-text" th:text="${isLoggedIn} ? 'ğŸ‘¤ íšŒì› ëª¨ë“œ (' + ${username} + 'ë‹˜)' : 'ğŸ‘‹ ë°˜ê°‘ìŠµë‹ˆë‹¤! (GUEST)'">ë¡œê·¸ì¸ ìƒíƒœ</div>

    <a th:if="${!isLoggedIn}" th:href="@{/login}" class="auth-btn login-btn">ë¡œê·¸ì¸</a>

    <form th:if="${isLoggedIn}" th:action="@{/logout}" method="post">
        <button type="submit" class="auth-btn logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </form>
</div>

<div class="menu-card">
    <span class="menu-title" th:text="${isLoggedIn} ? 'ğŸ“‚ ë‚˜ì˜ ì»¤ìŠ¤í…€ ë©”ë‰´' : 'ğŸ“‹ ê²ŒìŠ¤íŠ¸ ê¸°ë³¸ ë©”ë‰´'">í¸ì§‘ ì¤‘ì¸ ë©”ë‰´</span>
    <div id="menu-list"></div>

    <div class="input-group" th:if="${isLoggedIn}">
        <input type="text" id="menu-input" placeholder="ìƒˆ ë©”ë‰´ ì¶”ê°€" onkeypress="if(event.keyCode==13) addMenu()">
        <button class="add-btn" onclick="addMenu()">ì¶”ê°€</button>
    </div>
    <p th:if="${!isLoggedIn}" style="font-size: 12px; color: #999;">ë¡œê·¸ì¸í•˜ë©´ ë©”ë‰´ë¥¼ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
</div>

<div class="roulette-container">
    <div class="arrow"></div>
    <canvas id="canvas" width="400" height="400"></canvas>
</div>

<button class="spin-btn" onclick="spinWheel()">ë£°ë › ëŒë¦¬ê¸°!</button>
<div id="result"></div>

<script th:inline="javascript">
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');

    // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì´ˆê¸° ë°ì´í„°
    let currentMenu = [[${menuList}]];
    const isLoggedIn = [[${isLoggedIn}]];
    let currentRotation = 0;

    // 1. ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderMenuList() {
        const listDiv = document.getElementById('menu-list');
        listDiv.innerHTML = currentMenu.map((m, i) =>
            `<div class="menu-item">
                    ${m} ${isLoggedIn ? `<span class="del-btn" onclick="deleteMenu('${m}', ${i})">Ã—</span>` : ''}
                </div>`
        ).join('');
    }

    // 2. ë©”ë‰´ ì¶”ê°€ (DB ì—°ë™)
    async function addMenu() {
        const input = document.getElementById('menu-input');
        const menuName = input.value.trim();
        if (!menuName) return;

        // ì„œë²„ API í˜¸ì¶œ
        try {
            const response = await fetch('/api/menus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ menuName: menuName })
            });

            if (response.ok) {
                currentMenu.push(menuName);
                input.value = "";
                updateGame();
            }
        } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨!"); }
    }

    // 3. ë©”ë‰´ ì‚­ì œ (DB ì—°ë™)
    async function deleteMenu(menuName, index) {
        if (currentMenu.length <= 2) return alert("ìµœì†Œ 2ê°œì˜ ë©”ë‰´ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

        try {
            const response = await fetch('/api/menus/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ menuName: menuName })
            });

            if (response.ok) {
                currentMenu.splice(index, 1);
                updateGame();
            }
        } catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨!"); }
    }

    function updateGame() {
        renderMenuList();
        drawWheel();
    }

    // 4. ë£°ë › ê·¸ë¦¬ê¸°
    const colors = ["#6c5ce7", "#74b9ff", "#a29bfe", "#81ecec", "#55efc4", "#fab1a0", "#ff7675", "#fd79a8"];
    function drawWheel() {
        const totalSlices = currentMenu.length;
        const arc = (Math.PI * 2) / totalSlices;
        ctx.clearRect(0, 0, 400, 400);

        for (let i = 0; i < totalSlices; i++) {
            const angle = i * arc;
            ctx.fillStyle = colors[i % colors.length];
            ctx.beginPath();
            ctx.moveTo(200, 200);
            ctx.arc(200, 200, 200, angle, angle + arc);
            ctx.fill();

            ctx.save();
            ctx.translate(200 + Math.cos(angle + arc / 2) * 140, 200 + Math.sin(angle + arc / 2) * 140);
            ctx.rotate(angle + arc / 2 + Math.PI / 2);
            ctx.fillStyle = "white";
            ctx.font = "bold 15px Arial";
            ctx.textAlign = "center";
            ctx.fillText(currentMenu[i], 0, 0);
            ctx.restore();
        }
    }

    // 5. ë£°ë › ëŒë¦¬ê¸°
    function spinWheel() {
        resultDiv.innerText = "ë‘êµ¬ë‘êµ¬ë‘êµ¬...";
        const randomExtra = Math.floor(Math.random() * 360);
        const totalRotation = 1800 + randomExtra;
        currentRotation += totalRotation;

        canvas.style.transform = `rotate(-${currentRotation}deg)`;

        setTimeout(() => {
            const sliceDegree = 360 / currentMenu.length;
            const winnerIndex = Math.floor(((currentRotation % 360 + 270) % 360) / sliceDegree);
            resultDiv.innerText = `ì˜¤ëŠ˜ì˜ ë©”ë‰´: ${currentMenu[winnerIndex]}!`;
        }, 4000);
    }

    // ì´ˆê¸° ì‹¤í–‰
    updateGame();
</script>
</body>
</html>